# Data Model: Save Page to Chrome Bookmarks

**Feature**: `001-bookmark-inbox-dedup`  
**Date**: Saturday Dec 13, 2025  
**Phase**: 1 (Design)

## Overview

This feature operates on Chrome's native bookmark data structure. No additional storage or database is required. All entities are representations of Chrome bookmarks API objects with domain-specific processing logic.

---

## Entities

### 1. Bookmark (Chrome Native)

Represents a Chrome bookmark as returned by `chrome.bookmarks` API.

**Source**: `chrome.bookmarks.BookmarkTreeNode`

**Fields**:

| Field | Type | Required | Description | Validation |
|-------|------|----------|-------------|------------|
| `id` | string | Yes | Unique bookmark ID assigned by Chrome | Read-only, auto-generated |
| `title` | string | Yes | Display name of bookmark | 1-255 chars, extracted from page or fallback |
| `url` | string | Yes | Full URL of bookmarked page | Valid URL format, max 2048 chars |
| `parentId` | string | Yes | ID of parent folder | References another BookmarkTreeNode |
| `dateAdded` | number | Yes | Timestamp (ms since epoch) | Auto-generated by Chrome |
| `children` | array | No | Child bookmarks (for folders) | Only present if this is a folder |

**Relationships**:
- `parentId` → Links to parent BookmarkTreeNode (folder)
- Folder nodes have `children` array containing other BookmarkTreeNodes

**State Transitions**: None (bookmarks are created once, not modified by this feature)

---

### 2. NormalizedUrl (Computed)

Represents the canonical form of a URL used for duplicate detection.

**Source**: Computed from `bookmark.url` via `normalizeUrl()` function

**Structure**:

```javascript
{
  protocol: 'https:',
  hostname: 'docs.google.com',
  pathname: '/document/d/ABC123',  // No trailing verb
  // query params stripped
  // fragments stripped
}
```

**Normalization Rules**:

1. **Strip Query Parameters**: Remove everything after `?`
2. **Strip Fragments**: Remove everything after `#`
3. **Remove Google Docs Verbs**: Strip `/edit`, `/view`, `/preview`, `/copy` from end of pathname
4. **Normalize Trailing Slashes**: Consistent handling (always remove from paths)

**Examples**:

```javascript
// Input → Normalized Output
'https://example.com/page?session=123'           → 'https://example.com/page'
'https://example.com/page#section'               → 'https://example.com/page'
'https://docs.google.com/document/d/ABC123/edit' → 'https://docs.google.com/document/d/ABC123'
'https://example.com/path/'                      → 'https://example.com/path'
```

**Validation**:
- Must be a valid URL (checked via `URL` constructor)
- If invalid, returns original string (logged to console)

---

### 3. InboxFolder (Chrome BookmarkTreeNode)

Special folder used as default destination for new bookmarks.

**Source**: Found via `chrome.bookmarks.getTree()` search

**Identification Rules**:

- **Name**: "inbox" (case-insensitive match)
- **Location**: Root level only (direct child of Bookmark Bar or Other Bookmarks)
- **Type**: Folder (no `url` property, has `children` array)

**Search Algorithm**:

```javascript
function findInboxFolder(tree) {
  // Search only these root locations:
  const bookmarkBar = tree[0].children.find(n => n.id === '1');
  const otherBookmarks = tree[0].children.find(n => n.id === '2');
  
  for (const root of [bookmarkBar, otherBookmarks].filter(Boolean)) {
    const inbox = root.children?.find(child => 
      child.title?.toLowerCase() === 'inbox' && 
      !child.url  // Must be a folder
    );
    if (inbox) return inbox;
  }
  return null;
}
```

**Fallback Behavior**:
- If not found → Attempt creation via `chrome.bookmarks.create({ title: 'inbox', parentId: '1' })`
- If creation fails (permissions) → Place bookmark at top level

**Conflict Resolution** (multiple "inbox" folders):
- Use first found at root level (FR-005a)
- Ignore nested folders

---

## Processing Flows

### Bookmark Creation Flow

```
1. User clicks "Save Page" button
   ↓
2. Debounce check (ignore if < 1.5s since last click)
   ↓
3. Get current page URL and title
   ↓
4. Normalize URL → NormalizedUrl
   ↓
5. Search for existing bookmark with same NormalizedUrl
   ├─ Found → STOP (silent, no action)
   └─ Not found → Continue
   ↓
6. Find "inbox" folder
   ├─ Found → Use inbox.id as parentId
   ├─ Not found → Try create inbox folder
   │  ├─ Success → Use new folder id as parentId
   │  └─ Fail → Use '1' (Bookmark Bar) or '2' (Other Bookmarks) as parentId
   └─
   ↓
7. Create bookmark via chrome.bookmarks.create({ title, url, parentId })
   ↓
8. Done (silent)
```

### Title Extraction Flow

```
1. Get active tab via chrome.tabs.query()
   ↓
2. Check tab.title
   ├─ Exists and not empty → Use tab.title
   └─ Empty → Extract from content
      ↓
3. Inject content script to extract first text node
   ↓
4. Return first ~50 chars of meaningful text
   ├─ Found → Use as title
   └─ Not found → Use 'Untitled'
```

### Deduplication Logic

```
For each existing bookmark in Chrome:
  1. Normalize existing bookmark's URL
  2. Compare with new bookmark's normalized URL
  3. If match found → Return existing bookmark (cancel creation)
  4. If no match found after all bookmarks checked → Proceed with creation
```

**Performance Consideration**: Searching all bookmarks scales O(n) with bookmark count. For typical users (1-10k bookmarks), this completes in <100ms. Chrome's `search()` API doesn't support custom comparators, so full scan is necessary.

---

## Data Validation Rules

### URL Validation

| Rule | Check | Action on Failure |
|------|-------|-------------------|
| Valid URL format | `new URL(urlString)` doesn't throw | Log error, use original string |
| Max length | `url.length <= 2048` | Truncate (unlikely edge case) |
| Protocol | `https:` or `http:` (Chrome limitation) | Accept as-is (Chrome validates) |

### Title Validation

| Rule | Check | Action on Failure |
|------|-------|-------------------|
| Not empty | `title.trim().length > 0` | Extract from content or use 'Untitled' |
| Max length | `title.length <= 255` | Truncate with `...` |
| No newlines | `!title.includes('\n')` | Replace with spaces |

### Folder Validation

| Rule | Check | Action on Failure |
|------|-------|-------------------|
| Folder exists | `parentId` references valid folder | Fall back to top-level (id '1' or '2') |
| Folder writable | `chrome.bookmarks.create()` succeeds | Log error, return without bookmark |

---

## Storage & Persistence

**No Additional Storage Required**

- All data persists in Chrome's native bookmark database (IndexedDB internally)
- Chrome handles sync across devices via Google account
- Export available via Chrome's built-in bookmark export (`chrome://bookmarks`)
- No extension storage (`chrome.storage`) needed

**Benefits**:
- Zero maintenance - Chrome handles persistence
- Native sync - works automatically with user's Google account
- Backup/restore - user can use Chrome's built-in tools
- No data loss on extension uninstall

**Limitations**:
- Can't store metadata beyond title/URL/folder
- No custom tags or categories (out of scope)
- Chrome's bookmark API limits (2048 char URLs, 255 char titles)

---

## Security & Privacy

**Data Sensitivity**: Medium
- Bookmark URLs may contain sensitive paths or parameters
- Bookmark titles may reveal private documents

**Privacy Guarantees** (per Constitution Principle I):
- ✅ All processing local (no external API calls)
- ✅ No telemetry or analytics
- ✅ Uses only Chrome's native storage (encrypted at rest by Chrome if user enables)
- ✅ No bookmark data leaves device except via Chrome sync (user-controlled)

**Permissions Required**:
- `"bookmarks"` - Read/write access to user's bookmarks
- `"tabs"` - Read current tab URL/title
- `"scripting"` - Inject content script for title extraction (optional, for fallback)

**User Control**:
- User explicitly clicks "Save Page" (opt-in)
- Can delete/modify bookmarks via Chrome's bookmark manager
- Can export bookmarks via Chrome tools
- Can revoke extension permissions via Chrome settings

---

## Testing Strategy

### Unit Tests (Pure Functions)

```javascript
// tests/bookmark-manager.test.js
describe('normalizeUrl', () => {
  test('strips query params');
  test('strips fragments');
  test('removes Google Docs verbs');
  test('handles invalid URLs gracefully');
  test('preserves protocol and domain');
});

describe('findInboxFolder', () => {
  test('finds case-insensitive match');
  test('searches root level only');
  test('returns first match if multiple exist');
  test('returns null if not found');
});
```

### Integration Tests (Manual)

1. **Create bookmark** → Verify appears in Chrome bookmarks
2. **Duplicate detection** → Try saving same URL twice, verify only one exists
3. **Inbox folder** → Delete inbox, save page, verify inbox created
4. **Query params** → Save `example.com?foo=bar` after `example.com`, verify duplicate detected
5. **Google Docs** → Save doc with `/edit` after one with `/view`, verify duplicate detected
6. **Empty title** → Save page with no title, verify fallback works
7. **Rapid clicking** → Click Save Page 3x quickly, verify only one bookmark created
8. **Root level only** → Create nested "inbox" folder, verify not used

### Performance Tests

- **Benchmark**: Save bookmark with 5000 existing bookmarks → Should complete in <2s
- **Stress test**: Rapid clicking 10x → Should handle gracefully (debouncing)

---

## Future Extensions (Out of Scope for v1)

### Potential Enhancements

1. **Custom folder configuration** - Let user choose destination folder name
2. **Multiple folder targets** - Save to different folders based on domain/tags
3. **Bookmark metadata** - Store extraction timestamp, source extension version
4. **Bulk deduplication** - Scan existing bookmarks and merge duplicates
5. **Smart categorization** - Use domain or content to suggest folder
6. **Other Google products** - Extend verb normalization to Sheets, Slides, Forms
7. **Undo/Redo** - Track recent bookmark creations for quick undo

All defer to future versions per spec's "Out of Scope" section.
